@page "/"

@inject NavigationManager Navigator
@inject HttpClient Http

<PageTitle>Make trading contact</PageTitle>

<h3>Make contact with trader</h3>
<EditForm Model="@_exchangeState" OnSubmit="@HandleSubmit">
    <div>
        <label>
            Player Broker skill:
            <InputNumber id="PlayerBrokerSkill" @bind-Value="_exchangeState.PlayerBrokerSkill"/>
        </label>
    </div>

    <div>
        <label>
            Contact broker skill:
            <InputNumber id="ContractorBrokerSkill" @bind-Value="_exchangeState.ContractorBrokerSkill"/>
        </label>
    </div>

    <div>
        <label>
            World population code:
            <InputNumber id="WorldPopulation" @bind-Value="_exchangeState.WorldPopulation"/>
        </label>
    </div>

    <div>
        <label>
            Local law code:
            <InputNumber id="LocalLawLevel" @bind-Value="_exchangeState.LocalLawLevel"/>
        </label>
    </div>

    <div>
        <label>
            Is black market deal?
            <InputCheckbox id="IsBlackMarket" @bind-Value="_exchangeState.IsBlackMarket"/>
        </label>
    </div>

    @if (_tags is not null)
    {
        <div>

            <h4>World tags:</h4>

            @foreach (var tag in _tags)
            {
                <div>
                    <label>
                        @tag.Value
                        <input type="checkbox" 
                                           @onchange="eventArgs => { OnTagChanged(tag.Key, eventArgs.Value); }" />  
                    </label>
                </div>
            }
        </div>
    }


    <div>
        <button type="submit">Make</button>
    </div>
</EditForm>


@code {

    private readonly ExchangeState _exchangeState = new();

    private Dictionary<string, string>? _tags;

    protected override async Task OnInitializedAsync()
    {
        _exchangeState.RngSeed = new Random().Next();

        _tags = await Http.GetFromJsonAsync<Dictionary<string, string>>("trade-data/tags.json");

        await base.OnInitializedAsync();
    }

    private void OnTagChanged(string tag, object pressed)
    {
        var isTagActive = (bool)pressed;

        if (isTagActive)
        {
            _exchangeState.WorldTags.Add(tag);
        }
        else
        {
            _exchangeState.WorldTags.Remove(tag);
        }
    }

    private void HandleSubmit()
    {
        var stateString = _exchangeState.ToPortableString();

        Navigator.NavigateTo($"offers?state={stateString}");
    }

}